<div class="profile-container">
  <div class="profile-card">
    <h2>My Profile</h2>

    <div *ngIf="isLoading" class="loading">Loading user data...</div>

    <div class="user-info" *ngIf="currentUser$ | async as user">
      <div *ngIf="profileUpdateSuccess" class="success-message">
        Profile updated successfully!
      </div>

      <div *ngIf="profileUpdateError" class="error-message">
        {{ profileUpdateError }}
      </div>

      <form [formGroup]="profileForm" (ngSubmit)="onSaveProfile()" *ngIf="isEditing">
        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" id="email" formControlName="email" class="form-control"
            [class.is-invalid]="profileForm.get('email')?.invalid && profileForm.get('email')?.touched">
          <div *ngIf="profileForm.get('email')?.invalid && profileForm.get('email')?.touched" class="invalid-feedback">
            <small *ngIf="profileForm.get('email')?.errors?.['required']">Email is required</small>
            <small *ngIf="profileForm.get('email')?.errors?.['email']">Please enter a valid email</small>
          </div>
        </div>

        <div class="form-group">
          <label for="username">Username:</label>
          <input type="text" id="username" formControlName="username" class="form-control"
            [class.is-invalid]="profileForm.get('username')?.invalid && profileForm.get('username')?.touched">
          <div *ngIf="profileForm.get('username')?.invalid && profileForm.get('username')?.touched"
            class="invalid-feedback">
            <small *ngIf="profileForm.get('username')?.errors?.['required']">Username is required</small>
            <small *ngIf="profileForm.get('username')?.errors?.['minlength']">Username must be at least 3
              characters</small>
            <small *ngIf="profileForm.get('username')?.errors?.['maxlength']">Username must be no more than 20
              characters</small>
          </div>
        </div>

        <div class="password-section">
          <button type="button" class="btn-link" (click)="onTogglePasswordChange()">
            {{ showPasswordFields ? 'Cancel password change' : 'Change password' }}
          </button>

          <div *ngIf="showPasswordFields" class="password-fields">
            <div class="form-group">
              <label for="password">New Password:</label>
              <input type="password" id="password" formControlName="password" class="form-control">
            </div>

            <div class="form-group">
              <label for="passwordConfirmation">Confirm Password:</label>
              <input type="password" id="passwordConfirmation" formControlName="passwordConfirmation"
                class="form-control">
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary" [disabled]="isLoading || profileForm.invalid">
            {{ isLoading ? 'Saving...' : 'Save Changes' }}
          </button>
          <button type="button" class="btn-secondary" (click)="onCancelEdit()" [disabled]="isLoading">
            Cancel
          </button>
        </div>
      </form>

      <div *ngIf="!isEditing" class="user-display">
        <div class="info-group">
          <label>Email:</label>
          <span>{{ user.email || 'Not available' }}</span>
        </div>

        <div class="info-group">
          <label>Username:</label>
          <span>{{ user.username || 'Not available' }}</span>
        </div>

        <div class="info-group">
          <label>User ID:</label>
          <span>{{ user.id || 'Not available' }}</span>
        </div>

        <div class="profile-actions">
          <button type="button" (click)="onEditProfile()" class="btn-primary">
            Edit Profile
          </button>
          <button type="button" (click)="refreshUserData()" class="btn-secondary" [disabled]="isLoading">
            {{ isLoading ? 'Refreshing...' : 'Refresh Data' }}
          </button>
          <button type="button" (click)="logout()" class="btn-secondary">
            Logout
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Subscriptions Section -->
  <div class="subscriptions-card">
    <h2>My Subscriptions</h2>

    <div *ngIf="subscriptionsLoading" class="loading">Loading subscriptions...</div>

    <div *ngIf="!subscriptionsLoading && subscriptionsError" class="error-state">
      <p class="error-message">{{ subscriptionsError }}</p>
      <button (click)="loadUserSubscriptions()" class="retry-button">Retry</button>
    </div>

    <div *ngIf="!subscriptionsLoading && !subscriptionsError" class="subscriptions-content">
      <div *ngIf="subscriptions.length > 0; else noSubscriptions" class="subscriptions-grid">
        <div *ngFor="let subscription of subscriptions" class="subscription-card">
          <h3>{{ subscription.topicName }}</h3>
          <p>{{ subscription.topicDescription }}</p>
          <div class="subscription-meta">
            <small>Subscribed on: {{ subscription.subscribedAt | date:'short' }}</small>
          </div>
          <button class="unsubscribe-button" [disabled]="isUnsubscribing(subscription.topicId)"
            (click)="onUnsubscribe(subscription.topicId)">
            {{ isUnsubscribing(subscription.topicId) ? 'Unsubscribing...' : 'Se d√©sabonner' }}
          </button>
        </div>
      </div>

      <ng-template #noSubscriptions>
        <p class="no-subscriptions">You are not subscribed to any topics yet.</p>
      </ng-template>
    </div>
  </div>
</div>